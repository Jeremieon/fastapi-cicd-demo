name: CI/CD Pipeline with Staging

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

env:
  DOCKER_IMAGE: jeremy9k/fastapi-cicd-demo

jobs:
  test:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: pytest -v

  deploy-staging:
    needs: test
    if: github.ref == 'refs/heads/dev'
    runs-on: self-hosted
    env:
      name: taging
      url: http://192.168.0.67:8001

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set version
        id: version
        run: echo "VERSION=staging-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_TOKEN }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build and push Docker image
        run: |
          docker build -t ${{ env.DOCKER_IMAGE }}:staging .
          docker push ${{ env.DOCKER_IMAGE }}:staging

      - name: Deploy to Staging
        run: |
          chmod +x deploy.sh
          ./deploy.sh \
            ${{ env.DOCKER_IMAGE }}:staging \
            fastapi-staging \
            8001 \
            staging \
            ${{ steps.version.outputs.VERSION }}

      - name: Deployment notification
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "‚úÖ Staging deployment successful!"
            echo "üîó http://192.168.0.67:8001"
          else
            echo "‚ùå Staging deployment failed!"
          fi

  deploy-production:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: self-hosted
    env:
      name: production
      url: http://192.168.0.67:8000

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set version
        id: version
        run: echo "VERSION=v3.0.0" >> $GITHUB_OUTPUT

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_TOKEN }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build and push Docker image
        run: |
          docker build -t ${{ env.DOCKER_IMAGE }}:latest .
          docker tag ${{ env.DOCKER_IMAGE }}:latest ${{ env.DOCKER_IMAGE }}:${{ steps.version.outputs.VERSION }}
          docker push ${{ env.DOCKER_IMAGE }}:latest
          docker push ${{ env.DOCKER_IMAGE }}:${{ steps.version.outputs.VERSION }}

      - name: Deploy to Production
        run: |
          chmod +x deploy.sh
          ./deploy.sh \
            ${{ env.DOCKER_IMAGE }}:latest \
            fastapi-app \
            8000 \
            production \
            ${{ steps.version.outputs.VERSION }}

      - name: Deployment notification
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "üéâ Production deployment successful!"
            echo "üîó http://192.168.0.67:8000"
          else
            echo "‚ùå Production deployment failed and rolled back!"
          fi

      - name: Clean up old images
        if: success()
        run: |
          docker images ${{ env.DOCKER_IMAGE }} --format "{{.ID}} {{.CreatedAt}}" | tail -n +5 | awk '{print $1}' | xargs -r docker rmi || true
